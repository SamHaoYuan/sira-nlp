from django import test
from django.conf import settings

from app.lib import loaders
from app.models import *


class VulnerabilityLoaderTestCase(test.TestCase):
    def setUp(self):
        self.loader = loaders.VulnerabilityLoader(settings)

    def test_load(self):
        # Vulnerability
        expected = [
                ('CVE-2016-5165', 'blog'),
                ('CVE-2016-2845', 'manual'),
                ('CVE-2013-0908', 'manual')
            ]

        actual = self.loader.load()
        self.assertEqual(len(expected), actual, msg='Return')

        actual = list(Vulnerability.objects.values_list('id', 'source'))
        self.assertCountEqual(expected, actual, msg='Data: Vulnerability')

        # Bug
        expected = [
                (618037, 'Bug-Security', 'Redacted'),
                (542060, 'Bug-Security', 'Redacted'),
                (174059, 'Bug-Security', 'Redacted')
            ]
        actual = list(Bug.objects.values_list('id', 'type', 'status'))
        self.assertCountEqual(expected, actual, msg='Data: Bug')

        # Vulnerability to Bug Mapping
        expected = [
                ('CVE-2016-5165', 618037),
                ('CVE-2016-2845', 542060),
                ('CVE-2013-0908', 174059)
            ]
        actual = list(VulnerabilityBug.objects.values_list(
                'vulnerability_id', 'bug_id'
            ))
        self.assertCountEqual(expected, actual, msg='Data: VulnerabilityBug')
