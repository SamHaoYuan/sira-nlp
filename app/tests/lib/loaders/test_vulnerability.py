from django import test
from django.conf import settings

from app.lib import loaders
from app.models import *


class BugLoaderTestCase(test.TestCase):
    def setUp(self):
        self.loader = loaders.VulnerabilityLoader(settings)

    def test_load(self):
        expected = [
                ('CVE-2016-5165', 618037, 'blog'),
                ('CVE-2016-2845', 542060, 'manual'),
                ('CVE-2013-0908', 174059, 'manual')
            ]

        actual = self.loader.load()
        self.assertEqual(len(expected), actual, msg='Return')

        actual = list(Vulnerability.objects.values_list(
                'cve', 'bug_id', 'source'
            ))
        self.assertCountEqual(expected, actual, msg='Data:Vulnerability')

        expected = [
                (618037, 'Bug-Security', 'Redacted'),
                (542060, 'Bug-Security', 'Redacted'),
                (174059, 'Bug-Security', 'Redacted')
            ]
        actual = list(Bug.objects.values_list('id', 'type', 'status'))
        self.assertCountEqual(expected, actual, msg='Data:Bug')
