from django import test
from django.conf import settings

from app.lib import loaders, taggers
from app.models import *


class BugLoaderTestCase(test.TestCase):
    @classmethod
    def setUpTestData(cls):
        loader = loaders.BugLoader(settings, num_processes=2)
        _ = loader.load()
        loader = loaders.VulnerabilityLoader(settings, num_processes=2)
        _ = loader.load()
        loader = loaders.ReviewLoader(settings, num_processes=2)
        _ = loader.load()

    def setUp(self):
        self.tagger = taggers.MissedVulnerabilityTagger(settings)

    def test_load(self):
        expected = [
                1128633002, 1144393004, 1247623005, 1259853004, 1292403004,
                1444413002, 1544273002, 2085023003, 2134723002, 2168223002,
                2177983004, 2189523002, 2210603002, 2211423003
            ]

        _ = self.tagger.tag()
        actual = list(
                Review.objects.filter(missed_vulnerability=True)
                .values_list('id', flat=True)
            )
        self.assertCountEqual(expected, actual)
