from datetime import datetime

from app.models import *
from app.lib.taggers import tagger


class MissedVulnerabilityTagger(tagger.Tagger):
    def __init__(self, settings):
        super(MissedVulnerabilityTagger, self).__init__(settings)

    def _tag(self):
        files = self._get_filesfixedforvulnerability()
        ids = self._get_missedvulnerabilityreviewids(files)
        Review.objects.filter(id__in=ids).update(missed_vulnerability=True)

        return len(ids)

    def _get_vulnerabilityfixingreviews(self):
        reviews = set()
        for vulnerability in Vulnerability.objects.all():
            for review in vulnerability.bug.review_set.all():
                reviews.add(review)
        return reviews

    def _get_filesfixedforvulnerability(self):
        files = dict()
        for review in self._get_vulnerabilityfixingreviews():
            for file in review.document['committed_files']:
                if file not in files:
                    files[file] = datetime.min
                if review.created > files[file]:
                    files[file] = review.created
        return files

    def _get_missedvulnerabilityreviewids(self, files):
        ids = set()
        for (file, date) in files.items():
            if not self._is_whitelisted(file):
                continue
            reviews = Review.objects.filter(
                    created__lt=date, document__reviewed_files__contains=file
                )
            ids |= set(list(reviews.values_list('id', flat=True)))
        return ids

    def _is_whitelisted(self, file):
        for type in self.settings.FILETYPES_WHITELIST:
            if file.endswith(type):
                return True
        return False
