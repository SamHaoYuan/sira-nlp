"""
@AUTHOR: nuthanmunaiah
"""

from app.lib import files, helpers
from app.lib.loaders import loader
from app.models import *


class VulnerabilityLoader(loader.Loader):
    """
    Implements loader object.
    """
    def _load(self):
        """
        Grabs all of the vulnerabilities from the specified files, parses them,
        cleans them up, and saves them. Returns the total number of loaded
        vulnerabilities.
        """
        count = 0

        f = files.Files(self.settings)
        for (source, cve, bug_id) in f.get_vulnerabilities():
            b = helpers.get_row(Bug, id=bug_id)
            if b is None:
                b = Bug(id=bug_id, type='Bug-Security', status='Redacted')
                b.save()

            v = helpers.get_row(Vulnerability, id=cve)
            if v is None:
                v = Vulnerability(id=cve, source=source)
                v.save()

            vb = VulnerabilityBug(vulnerability=v, bug=b)
            vb.save()

            count += 1

        return count
